within NZW_draft2;
model SepticTank

  replaceable package MediumA = Buildings.Media.Air "Medium air";
  replaceable package MediumW = Buildings.Media.Water "Medium water";

  parameter Modelica.SIunits.MassFlowRate mSepFloNominal= 0.5 "Dorm flow rate";
  parameter Modelica.SIunits.MassFlowRate mLifPumFloNominal= 64*3.78541/60 "Dorm flow rate";

  parameter Modelica.SIunits.Length pipeThickness = 0.001 "PVC pipe thickness";
  parameter Modelica.SIunits.Length tankThickness = 0.001 "Plastic tank thickness";



  //parameter Modelica.SIunits.ThermalConductance G


  Modelica.Blocks.Sources.CombiTimeTable DorFlo(tableOnFile=false, table=[0,0;
        900,0; 1800,0; 2700,0; 3600,0; 4500,0; 5400,0; 6300,0; 7200,0; 8100,0;
        9000,0; 9900,0; 10800,0.138798367; 11700,0; 12600,0; 13500,0; 14400,0;
        15300,0; 16200,0; 17100,0; 18000,0; 18900,0; 19800,0; 20700,0; 21600,0;
        22500,0; 23400,0; 24300,0; 25200,0; 26100,0; 27000,0; 27900,0; 28800,0;
        29700,0; 30600,0; 31500,0; 32400,0; 33300,0; 34200,0; 35100,0; 36000,0;
        36900,0; 37800,0; 38700,0; 39600,0; 40500,0; 41400,0; 42300,0; 43200,0;
        44100,0; 45000,0.145107383; 45900,0; 46800,0; 47700,0.138798367; 48600,
        0; 49500,0; 50400,0; 51300,0; 52200,0; 53100,0; 54000,0; 54900,0; 55800,
        0; 56700,0; 57600,0; 58500,0; 59400,0; 60300,0; 61200,0; 62100,0; 63000,
        0; 63900,0; 64800,0; 65700,0; 66600,0; 67500,0; 68400,0.138798367;
        69300,0.138798367; 70200,0.157725417; 71100,0; 72000,0; 72900,0; 73800,
        0; 74700,0; 75600,0; 76500,0; 77400,0; 78300,0; 79200,0; 80100,0; 81000,
        0; 81900,0; 82800,0.145107383; 83700,0; 84600,0; 85500,0; 86400,0;
        87300,0; 88200,0; 89100,0; 90000,0; 90900,0; 91800,0; 92700,0; 93600,0;
        94500,0; 95400,0; 96300,0; 97200,0; 98100,0; 99000,0; 99900,0; 100800,0;
        101700,0; 102600,0; 103500,0; 104400,0; 105300,0; 106200,0; 107100,0;
        108000,0; 108900,0; 109800,0; 110700,0; 111600,0; 112500,0; 113400,0;
        114300,0; 115200,0; 116100,0; 117000,0; 117900,0; 118800,0; 119700,0;
        120600,0; 121500,0; 122400,0; 123300,0; 124200,0; 125100,0; 126000,0;
        126900,0; 127800,0; 128700,0; 129600,0; 130500,0; 131400,0; 132300,0;
        133200,0; 134100,0; 135000,0; 135900,0; 136800,0.145107383; 137700,
        0.138798367; 138600,0; 139500,0; 140400,0; 141300,0; 142200,0.239742633;
        143100,0.138798367; 144000,0; 144900,0; 145800,0; 146700,0; 147600,0;
        148500,0.239742633; 149400,0; 150300,0; 151200,0; 152100,0; 153000,0;
        153900,0; 154800,0; 155700,0; 156600,0; 157500,0; 158400,0; 159300,0;
        160200,0; 161100,0; 162000,0; 162900,0; 163800,0; 164700,0; 165600,0;
        166500,0; 167400,0; 168300,0; 169200,0; 170100,0; 171000,0.05678115;
        171900,0; 172800,0; 173700,0; 174600,0; 175500,0; 176400,0; 177300,0;
        178200,0; 179100,0; 180000,0; 180900,0; 181800,0; 182700,0; 183600,0;
        184500,0; 185400,0; 186300,0; 187200,0; 188100,0; 189000,0; 189900,0;
        190800,0; 191700,0; 192600,0; 193500,0; 194400,0; 195300,0; 196200,0;
        197100,0; 198000,0; 198900,0; 199800,0; 200700,0.277596733; 201600,0;
        202500,0; 203400,0; 204300,0; 205200,0; 206100,0.145107383; 207000,0;
        207900,0.138798367; 208800,0; 209700,0; 210600,0; 211500,0; 212400,0;
        213300,0; 214200,0; 215100,0; 216000,0; 216900,0; 217800,0; 218700,0;
        219600,0; 220500,0; 221400,0; 222300,0; 223200,0; 224100,0; 225000,0;
        225900,0; 226800,0; 227700,0; 228600,0; 229500,0; 230400,0; 231300,0;
        232200,0; 233100,0; 234000,0; 234900,0; 235800,0.138798367; 236700,0;
        237600,0; 238500,0; 239400,0; 240300,0; 241200,0; 242100,0; 243000,0;
        243900,0; 244800,0; 245700,0.145107383; 246600,0; 247500,0; 248400,0;
        249300,0; 250200,0; 251100,0; 252000,0; 252900,0; 253800,0.157725417;
        254700,0; 255600,0; 256500,0; 257400,0; 258300,0; 259200,0; 260100,0;
        261000,0; 261900,0; 262800,0; 263700,0; 264600,0; 265500,0; 266400,0;
        267300,0; 268200,0; 269100,0; 270000,0; 270900,0; 271800,0; 272700,0;
        273600,0; 274500,0; 275400,0; 276300,0; 277200,0; 278100,0; 279000,0;
        279900,0; 280800,0; 281700,0; 282600,0; 283500,0; 284400,0; 285300,0;
        286200,0; 287100,0; 288000,0; 288900,0; 289800,0; 290700,0; 291600,0;
        292500,0; 293400,0; 294300,0; 295200,0; 296100,0; 297000,0; 297900,0;
        298800,0; 299700,0; 300600,0; 301500,0; 302400,0; 303300,0; 304200,0;
        305100,0; 306000,0; 306900,0; 307800,0; 308700,0; 309600,0; 310500,0;
        311400,0; 312300,0; 313200,0; 314100,0; 315000,0; 315900,0; 316800,0;
        317700,0; 318600,0; 319500,0; 320400,0; 321300,0; 322200,0; 323100,0;
        324000,0; 324900,0; 325800,0; 326700,0; 327600,0; 328500,0; 329400,0;
        330300,0; 331200,0; 332100,0.138798367; 333000,0; 333900,0; 334800,0;
        335700,0; 336600,0; 337500,0; 338400,0; 339300,0; 340200,0; 341100,0;
        342000,0; 342900,0; 343800,0; 344700,0; 345600,0; 346500,0; 347400,0;
        348300,0; 349200,0; 350100,0; 351000,0.1514164; 351900,0; 352800,0;
        353700,0; 354600,0; 355500,0; 356400,0; 357300,0; 358200,0; 359100,0;
        360000,0; 360900,0; 361800,0; 362700,0; 363600,0; 364500,0; 365400,0;
        366300,0; 367200,0; 368100,0; 369000,0; 369900,0; 370800,0; 371700,0;
        372600,0; 373500,0; 374400,0; 375300,0; 376200,0; 377100,0; 378000,0;
        378900,0; 379800,0; 380700,0; 381600,0; 382500,0; 383400,0; 384300,
        0.145107383; 385200,0.145107383; 386100,0; 387000,0; 387900,0; 388800,0;
        389700,0; 390600,0; 391500,0; 392400,0; 393300,0; 394200,0.1514164;
        395100,0; 396000,0; 396900,0; 397800,0; 398700,0; 399600,0; 400500,0;
        401400,0; 402300,0; 403200,0; 404100,0; 405000,0; 405900,0; 406800,0;
        407700,0; 408600,0; 409500,0; 410400,0; 411300,0; 412200,0; 413100,0;
        414000,0; 414900,0; 415800,0; 416700,0; 417600,0; 418500,0; 419400,0;
        420300,0; 421200,0; 422100,0; 423000,0; 423900,0; 424800,0; 425700,0;
        426600,0; 427500,0; 428400,0; 429300,0; 430200,0; 431100,0; 432000,0;
        432900,0; 433800,0; 434700,0; 435600,0.1514164; 436500,0; 437400,0;
        438300,0; 439200,0; 440100,0; 441000,0; 441900,0; 442800,0; 443700,0;
        444600,0; 445500,0; 446400,0; 447300,0; 448200,0; 449100,0; 450000,0;
        450900,0; 451800,0; 452700,0; 453600,0; 454500,0; 455400,0; 456300,0;
        457200,0; 458100,0; 459000,0; 459900,0; 460800,0; 461700,0; 462600,0;
        463500,0; 464400,0; 465300,0; 466200,0; 467100,0; 468000,0.239742633;
        468900,0; 469800,0; 470700,0; 471600,0; 472500,0; 473400,0; 474300,0;
        475200,0; 476100,0.157725417; 477000,0; 477900,0; 478800,0; 479700,0;
        480600,0; 481500,0; 482400,0; 483300,0; 484200,0.252360667; 485100,0;
        486000,0; 486900,0; 487800,0; 488700,0; 489600,0; 490500,0; 491400,0;
        492300,0; 493200,0; 494100,0; 495000,0; 495900,0; 496800,0; 497700,0;
        498600,0; 499500,0; 500400,0; 501300,0; 502200,0; 503100,0; 504000,0;
        504900,0; 505800,0; 506700,0; 507600,0; 508500,0; 509400,0; 510300,0;
        511200,0; 512100,0; 513000,0; 513900,0; 514800,0; 515700,0; 516600,0;
        517500,0; 518400,0; 519300,0; 520200,0; 521100,0; 522000,0; 522900,0;
        523800,0; 524700,0; 525600,0; 526500,0.138798367; 527400,0; 528300,0;
        529200,0; 530100,0; 531000,0; 531900,0; 532800,0; 533700,0; 534600,0;
        535500,0; 536400,0; 537300,0; 538200,0; 539100,0; 540000,0; 540900,0;
        541800,0; 542700,0; 543600,0; 544500,0; 545400,0; 546300,0; 547200,0;
        548100,0; 549000,0; 549900,0; 550800,0; 551700,0; 552600,0; 553500,
        0.082017217; 554400,0; 555300,0; 556200,0; 557100,0; 558000,0; 558900,0;
        559800,0; 560700,0; 561600,0; 562500,0; 563400,0; 564300,0; 565200,0;
        566100,0; 567000,0; 567900,0; 568800,0; 569700,0; 570600,0; 571500,0;
        572400,0; 573300,0; 574200,0; 575100,0; 576000,0; 576900,0; 577800,0;
        578700,0; 579600,0; 580500,0; 581400,0; 582300,0; 583200,0; 584100,0;
        585000,0; 585900,0; 586800,0; 587700,0; 588600,0; 589500,0; 590400,0;
        591300,0; 592200,0; 593100,0; 594000,0; 594900,0; 595800,0; 596700,0;
        597600,0; 598500,0; 599400,0; 600300,0; 601200,0; 602100,0; 603000,0;
        603900,0; 604800,0; 605700,0; 606600,0.296523783; 607500,0.138798367;
        608400,0.138798367; 609300,0; 610200,0; 611100,0; 612000,0; 612900,0;
        613800,0; 614700,0.1514164; 615600,0; 616500,0; 617400,0; 618300,0;
        619200,0; 620100,0; 621000,0; 621900,0; 622800,0; 623700,0; 624600,0;
        625500,0; 626400,0; 627300,0; 628200,0; 629100,0; 630000,0; 630900,0;
        631800,0; 632700,0; 633600,0; 634500,0; 635400,0; 636300,0; 637200,0;
        638100,0; 639000,0; 639900,0; 640800,0; 641700,0; 642600,0; 643500,0;
        644400,0; 645300,0; 646200,0.13248935; 647100,0; 648000,0; 648900,0;
        649800,0; 650700,0.24605165; 651600,0; 652500,0; 653400,0; 654300,0;
        655200,0; 656100,0; 657000,0.138798367; 657900,0; 658800,0; 659700,0;
        660600,0; 661500,0; 662400,0; 663300,0; 664200,0; 665100,0; 666000,0;
        666900,0; 667800,0; 668700,0; 669600,0; 670500,0; 671400,0; 672300,0;
        673200,0; 674100,0; 675000,0; 675900,0; 676800,0; 677700,0; 678600,0;
        679500,0; 680400,0; 681300,0; 682200,0; 683100,0; 684000,0; 684900,0;
        685800,0; 686700,0; 687600,0; 688500,0.145107383; 689400,0; 690300,0;
        691200,0; 692100,0; 693000,0.13248935; 693900,0; 694800,0; 695700,0;
        696600,0; 697500,0; 698400,0; 699300,0; 700200,0; 701100,0; 702000,0;
        702900,0; 703800,0; 704700,0; 705600,0; 706500,0; 707400,0; 708300,0;
        709200,0; 710100,0; 711000,0; 711900,0; 712800,0; 713700,0; 714600,0;
        715500,0; 716400,0; 717300,0; 718200,0; 719100,0; 720000,0; 720900,
        0.082017217; 721800,0; 722700,0; 723600,0; 724500,0; 725400,0; 726300,0;
        727200,0; 728100,0; 729000,0; 729900,0; 730800,0; 731700,0; 732600,0;
        733500,0; 734400,0; 735300,0; 736200,0; 737100,0; 738000,0; 738900,0;
        739800,0; 740700,0; 741600,0; 742500,0; 743400,0; 744300,0; 745200,0;
        746100,0; 747000,0; 747900,0; 748800,0.13248935; 749700,0; 750600,0;
        751500,0.145107383; 752400,0; 753300,0; 754200,0; 755100,0; 756000,0;
        756900,0; 757800,0; 758700,0; 759600,0; 760500,0; 761400,0; 762300,0;
        763200,0; 764100,0; 765000,0; 765900,0; 766800,0; 767700,0; 768600,0;
        769500,0; 770400,0; 771300,0; 772200,0; 773100,0; 774000,0; 774900,0;
        775800,0; 776700,0; 777600,0; 778500,0; 779400,0; 780300,0; 781200,0;
        782100,0; 783000,0; 783900,0; 784800,0; 785700,0; 786600,0; 787500,0;
        788400,0; 789300,0; 790200,0; 791100,0; 792000,0; 792900,0; 793800,0;
        794700,0; 795600,0; 796500,0; 797400,0; 798300,0; 799200,0; 800100,0;
        801000,0; 801900,0; 802800,0; 803700,0; 804600,0; 805500,0; 806400,0;
        807300,0; 808200,0; 809100,0; 810000,0; 810900,0; 811800,0; 812700,0;
        813600,0; 814500,0; 815400,0; 816300,0; 817200,0; 818100,0; 819000,0;
        819900,0; 820800,0; 821700,0; 822600,0; 823500,0; 824400,0; 825300,
        0.145107383; 826200,0; 827100,0; 828000,0; 828900,0; 829800,0; 830700,
        0.138798367; 831600,0; 832500,0; 833400,0; 834300,0; 835200,0; 836100,0;
        837000,0; 837900,0; 838800,0.09463525; 839700,0; 840600,0; 841500,0;
        842400,0; 843300,0; 844200,0; 845100,0; 846000,0; 846900,0; 847800,0;
        848700,0; 849600,0; 850500,0; 851400,0; 852300,0; 853200,0; 854100,0;
        855000,0; 855900,0.13248935; 856800,0.138798367; 857700,0; 858600,
        0.422704117; 859500,0.13248935; 860400,0.063090167; 861300,0; 862200,0;
        863100,0; 864000,0])
    annotation (Placement(transformation(extent={{-140,30},{-120,50}})));
  Buildings.Fluid.Sources.MassFlowSource_T dorFloSou(
    use_m_flow_in=true,
    redeclare package Medium = MediumW,
    nPorts=1,
    T=308.15) annotation (Placement(transformation(extent={{-52,30},{-32,50}})));
  Buildings.Fluid.FixedResistances.Pipe SepTanInPip(
    length=10,
    diameter=0.02,
    redeclare package Medium = MediumW,
    lambdaIns=10,
    thicknessIns=pipeThickness,
    m_flow_nominal=mSepFloNominal)
    annotation (Placement(transformation(extent={{10,30},{30,50}})));
Modelica.Fluid.Vessels.OpenTank SepTan(
    height=1,
    redeclare package Medium = MediumW,
    use_T_start=true,
    nPorts=2,
    use_portsData=false,
    portsData={Modelica.Fluid.Vessels.BaseClasses.VesselPortsData(
        diameter=0.05,
        height=0.03,
        zeta_out=0.5,
        zeta_in=1.04),Modelica.Fluid.Vessels.BaseClasses.VesselPortsData(
        diameter=0.05,
        height=0.03,
        zeta_out=0.5,
        zeta_in=1.04)},
    crossArea=4.15,
    level_start=0.49,
    redeclare model HeatTransfer =
        Modelica.Fluid.Vessels.BaseClasses.HeatTransfer.ConstantHeatTransfer (
        k=0.53,
        T_ambient=293.15,
        alpha0=0.19),
    use_HeatTransfer=true,
    p_ambient=101325,
    T_ambient=293.15,
    T_start=308.15,
    m_flow_nominal=mLifPumFloNominal)
    annotation (Placement(transformation(extent={{96,70},{136,110}})));
Buildings.Fluid.Movers.FlowControlled_m_flow SepTanPum(redeclare package Medium =
        MediumW, m_flow_nominal=mLifPumFloNominal)
                                                  annotation (Placement(
        transformation(
        extent={{-10,10},{10,-10}},
        rotation=-90,
        origin={120,0})));
  Buildings.Fluid.Sources.FixedBoundary bou(redeclare package Medium = MediumW,
    nPorts=1,
    p=101325)
    annotation (Placement(transformation(extent={{-10,-10},{10,10}},
        rotation=90,
        origin={120,-56})));
  Modelica.Blocks.Sources.RealExpression SepTanLev(y=SepTan.level)
    annotation (Placement(transformation(extent={{-60,-10},{-40,10}})));
  Modelica.Blocks.Math.Gain gain(k=mLifPumFloNominal)
    annotation (Placement(transformation(extent={{20,-10},{40,10}})));
  inner Modelica.Fluid.System system
    annotation (Placement(transformation(extent={{120,-140},{140,-120}})));
  Buildings.Fluid.Sensors.TemperatureTwoPort SepTanInTem1(
    redeclare package Medium = MediumW,
    T_start=308.15,
    m_flow_nominal=mSepFloNominal)
    annotation (Placement(transformation(extent={{-20,30},{0,50}})));
  Buildings.Fluid.Sensors.TemperatureTwoPort SepTanOutTem2(redeclare package
      Medium = MediumW, m_flow_nominal=mLifPumFloNominal)  annotation (
      Placement(transformation(
        extent={{-10,-10},{10,10}},
        rotation=-90,
        origin={120,-28})));
  Modelica.Thermal.HeatTransfer.Sources.FixedTemperature TOut(T=293.15)
    "Outside Temperature" annotation (Placement(transformation(
        extent={{-10,-10},{10,10}},
        rotation=-90,
        origin={20,110})));
  Modelica.Thermal.HeatTransfer.Components.ThermalConductor thermalConductor(G=1)
           annotation (Placement(transformation(
        extent={{-10,-10},{10,10}},
        rotation=90,
        origin={20,70})));
  STPumpController SepTanPumCon
    annotation (Placement(transformation(extent={{-20,-10},{0,10}})));
  Buildings.Fluid.Sensors.TemperatureTwoPort SepTanInTem2(
    redeclare package Medium = MediumW,
    T_start=308.15,
    m_flow_nominal=mSepFloNominal)
    annotation (Placement(transformation(extent={{54,30},{74,50}})));
  Buildings.Fluid.Sensors.TemperatureTwoPort SepTanOutTem1(
    redeclare package Medium = MediumW,
    T_start=308.15,
    m_flow_nominal=mLifPumFloNominal)
                    annotation (Placement(transformation(
        extent={{-10,-10},{10,10}},
        rotation=-90,
        origin={120,36})));
equation
  connect(gain.y, SepTanPum.m_flow_in)
    annotation (Line(points={{41,0},{108,0},{108,0.2}}, color={0,0,127}));
  connect(dorFloSou.ports[1], SepTanInTem1.port_a)
    annotation (Line(points={{-32,40},{-20,40}}, color={0,127,255}));
  connect(SepTanInTem1.port_b, SepTanInPip.port_a)
    annotation (Line(points={{0,40},{10,40}}, color={0,127,255}));
  connect(SepTanPum.port_b, SepTanOutTem2.port_a)
    annotation (Line(points={{120,-10},{120,-18}}, color={0,127,255}));
  connect(SepTanOutTem2.port_b, bou.ports[1])
    annotation (Line(points={{120,-38},{120,-46}}, color={0,127,255}));
  connect(thermalConductor.port_b, TOut.port)
    annotation (Line(points={{20,80},{20,80},{20,100}}, color={191,0,0}));
  connect(SepTanPumCon.y, gain.u)
    annotation (Line(points={{1,0},{1,0},{18,0}}, color={0,0,127}));
  connect(SepTanPumCon.ST_level, SepTanLev.y)
    annotation (Line(points={{-22,0},{-39,0}}, color={0,0,127}));
  connect(SepTan.ports[1],SepTanInTem2. port_b) annotation (Line(points={{112,
          70},{114,70},{114,40},{74,40}}, color={0,127,255}));
  connect(SepTanInTem2.port_a, SepTanInPip.port_b)
    annotation (Line(points={{54,40},{30,40}}, color={0,127,255}));
  connect(SepTan.ports[2], SepTanOutTem1.port_a)
    annotation (Line(points={{120,70},{120,70},{120,46}}, color={0,127,255}));
  connect(SepTanOutTem1.port_b, SepTanPum.port_a)
    annotation (Line(points={{120,26},{120,10}}, color={0,127,255}));
  connect(DorFlo.y[1],dorFloSou. m_flow_in) annotation (Line(points={{-119,40},
          {-86,40},{-86,48},{-52,48}}, color={0,0,127}));
  connect(thermalConductor.port_a, SepTanInPip.heatPort)
    annotation (Line(points={{20,60},{20,45}}, color={191,0,0}));
  annotation (Icon(coordinateSystem(preserveAspectRatio=false,
        extent={{-150,-150},{150,150}},
        initialScale=0.1)),                                      Diagram(
        coordinateSystem(preserveAspectRatio=false,
        extent={{-150,-150},{150,150}},
        initialScale=0.1)));
end SepticTank;
